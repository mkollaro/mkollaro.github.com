---
layout: post
title: "How the GPU code works in Chromium"
tags: [Chromium]
---

As you might know from reading about the multi-process architecture of Chromium,
there is (approximatelly) one rendering process for each website you visit. This
process is sandboxed and is very restricted in what it can access, which makes
it hard for malicious web content to mess with your computer. However, this is
bad news for GPU acceleration - the renderer doesn't even have access to the
GPU. This is solved by adding an extra process just for the GPU commands - which
sounds horrible at first, since it introduces a lot of inter-process
communication and the textures have to be copied between the processes too, but
it's not as bad as you'd imagine. For one, the textures have to be usually
copied only once at initialization, and modern OpenGL is designed to minimize
the number of commands that have to be sent to the GPU.

Another complication when trying to understand these parts of code is that you
won't find direct calls to OpenGL - you will find calls to wrappers around
them. Each GL command has some wrapping code around it, which is autogenerated
from a Python script. This adds multiple advantages - you can automatically add
logging and tracing messages to each GL call, you can enable glError checks
after each command and you can blacklist certain features on certain drivers.
The wrappers are generated in `gpu/command_buffer/build_gles2_cmd_buffer.py` and
the resulting files always have `autogenerated` in their file name. The
autogenerated files are managed by git, not just created during the build, so
you can add whatever `printf` messages into them for debugging, without worrying
that they will get rewritten during the compilation.

Since the commands are received asynchronously (?) trough IPC, they are put into
a command buffer and executed from there, which makes it a bit difficult to
debug (see `gpu/command_buffer/service/gles2_cmd_decoder.cc`)

## Debugging GPU code

--in-process-gpu
--gpu-launcher
[apitrace](https://github.com/apitrace/)
